{"version":3,"sources":["../../../../../music-studio-app/src/actions/studio.ts","../../../../../music-studio-app/.next-internal/server/app/admin/%28protected%29/coupons/page/actions.js%20%28server%20actions%20loader%29","../../../../../music-studio-app/src/actions/coupon.ts"],"sourcesContent":["\"use server\";\n\nimport {\n    getAllStudiosFromFirestore,\n    getStudioByIdFromFirestore,\n    saveStudioToFirestore,\n    deleteStudioFromFirestore\n} from \"@/lib/db-firestore\";\nimport { StudioProfile } from \"@/lib/db-studio\";\nimport { revalidatePath } from \"next/cache\";\nimport { v4 as uuidv4 } from \"uuid\";\n\n// Get All\nexport async function fetchStudios() {\n    return getAllStudiosFromFirestore();\n}\n\n// Get One\nexport async function fetchStudio(id: string) {\n    return getStudioByIdFromFirestore(id);\n}\n\n// Upsert\nexport async function updateStudio(data: StudioProfile) {\n    try {\n        await saveStudioToFirestore(data);\n        revalidatePath(\"/studios\");\n        revalidatePath(`/studios/${data.id}`);\n        return { success: true, message: \"Studio saved successfully.\" };\n    } catch (e: any) {\n        return { success: false, message: e.message };\n    }\n}\n\n// Create New\nexport async function createNewStudioAction() {\n    const newStudio: StudioProfile = {\n        id: uuidv4(),\n        storeName: \"New Studio\",\n        representative: \"\",\n        manager: \"\",\n        contactPerson: \"\",\n        address: \"\",\n        phone: \"\",\n        email: \"\",\n        businessHours: { weekday: \"10:00-22:00\", saturday: \"10:00-22:00\", sundayHoliday: \"10:00-22:00\" },\n        url: \"\",\n        studioCount: 0,\n        rooms: [],\n        studentDiscount: { enabled: false, discountType: 'amount', value: 0 },\n        otherDiscounts: [],\n        personalPracticeSettings: { enabled: true, reservationWindowType: 'days', reservationWindowValue: 1, maxPeople: 2 },\n        designSettings: { logoSize: 100, backgroundColor: \"#000000\", backgroundType: 'color' },\n        equipmentOptions: [],\n        createdAt: new Date().toISOString()\n    };\n    await saveStudioToFirestore(newStudio);\n    revalidatePath(\"/studios\");\n    return newStudio.id;\n}\n\n// Delete\nexport async function deleteStudioAction(id: string) {\n    await deleteStudioFromFirestore(id);\n    revalidatePath(\"/studios\");\n    return { success: true };\n}\n","export {adminLogout as '006af075316706db006bce5619a543b7baa153f247'} from 'ACTIONS_MODULE0'\nexport {getAuthInfo as '0085772fd2329d46f7302aede12ceb7d687cfee89e'} from 'ACTIONS_MODULE0'\nexport {checkAdminAuth as '0089a1f7cb2a7fadf26749d87f9fcdbc1f15b236d8'} from 'ACTIONS_MODULE0'\nexport {requireAdminAuth as '00cc8a2f516f8fd155c8dc632b4a1c0a38dab84afa'} from 'ACTIONS_MODULE0'\nexport {storeLogin as '40530a7c11e54431ea05abc98c22a440f2a6e9ff9a'} from 'ACTIONS_MODULE0'\nexport {adminLogin as '60dc2d980d08fe70a6632f1c2387a539aa45c05dbf'} from 'ACTIONS_MODULE0'\nexport {adminLogout as '006af075316706db006bce5619a543b7baa153f247'} from 'ACTIONS_MODULE0'\nexport {getAuthInfo as '0085772fd2329d46f7302aede12ceb7d687cfee89e'} from 'ACTIONS_MODULE0'\nexport {fetchStudios as '00e4c93b8752da6310062bf7641dee775c057867ca'} from 'ACTIONS_MODULE1'\nexport {fetchStudio as '40f3f415047df7d6f80b4eeb845beddaafcd2f52bb'} from 'ACTIONS_MODULE1'\nexport {updateStudio as '404b0dc80b6afb3ebc6ef733601d064b54b160fee4'} from 'ACTIONS_MODULE1'\nexport {createNewStudioAction as '00c0bbb4b1415d1cd7c9373ddf7699da1ac1714148'} from 'ACTIONS_MODULE1'\nexport {deleteStudioAction as '40273ea227268ba866faf368020cc212388113d420'} from 'ACTIONS_MODULE1'\nexport {fetchCoupons as '00422208a51b5663b9e615a47c358d26b4ad0de769'} from 'ACTIONS_MODULE2'\nexport {generateCoupon as '4006ee327384973dc7230516f685a2df53875192d2'} from 'ACTIONS_MODULE2'\nexport {deleteCoupon as '409094c6682faddea444e16d8079894da6643581c6'} from 'ACTIONS_MODULE2'\nexport {fetchStudios as '0004ce98d57b4e58c117a5709faf9f06f304d07903'} from 'ACTIONS_MODULE2'\n","\"use server\";\n\nimport { v4 as uuidv4 } from \"uuid\";\nimport { getAllStudios } from \"@/lib/db-studio\";\nimport {\n    getAllCouponsFromFirestore,\n    saveCouponToFirestore,\n    deleteCouponFromFirestore,\n    Coupon\n} from \"@/lib/db-firestore\";\n\n// Generate random coupon code\nfunction generateCouponCode(): string {\n    const chars = \"ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n    let code = \"\";\n    for (let i = 0; i < 8; i++) {\n        code += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return code;\n}\n\n// Get all coupons\nexport async function fetchCoupons(): Promise<Coupon[]> {\n    return getAllCouponsFromFirestore();\n}\n\n// Get studios (for target selection)\nexport async function fetchStudios() {\n    return await getAllStudios();\n}\n\n// Generate new coupon\nexport async function generateCoupon(data: {\n    title: string;\n    discountType: \"percentage\" | \"fixed\";\n    discountValue: number;\n    maxUses: number;\n    validFrom: string;\n    validUntil: string;\n    targetStudioIds: string[];\n}): Promise<{ success: boolean; couponId: string; code: string }> {\n    const coupons = await fetchCoupons();\n\n    // Generate unique code\n    let code = generateCouponCode();\n    while (coupons.some((c) => c.code === code)) {\n        code = generateCouponCode();\n    }\n\n    // Check if coupon is currently valid\n    const today = new Date().toISOString().split(\"T\")[0];\n    const isActive = data.validFrom <= today && data.validUntil >= today;\n\n    const newCoupon: Coupon = {\n        id: uuidv4(),\n        code,\n        ...data,\n        usedCount: 0,\n        isActive,\n        createdAt: new Date().toISOString(),\n    };\n\n    await saveCouponToFirestore(newCoupon);\n\n    return { success: true, couponId: newCoupon.id, code };\n}\n\n// Delete coupon\nexport async function deleteCoupon(id: string): Promise<{ success: boolean }> {\n    try {\n        await deleteCouponFromFirestore(id);\n        return { success: true };\n    } catch (e) {\n        return { success: false };\n    }\n}\n\n// Validate and apply coupon\nexport async function validateCoupon(\n    code: string,\n    studioId: string\n): Promise<{\n    valid: boolean;\n    discount?: { type: \"percentage\" | \"fixed\"; value: number };\n    message?: string;\n}> {\n    const coupons = await fetchCoupons();\n    const coupon = coupons.find((c) => c.code === code);\n\n    if (!coupon) {\n        return { valid: false, message: \"クーポンコードが無効です\" };\n    }\n\n    const today = new Date().toISOString().split(\"T\")[0];\n\n    if (!coupon.isActive) {\n        return { valid: false, message: \"このクーポンは無効です\" };\n    }\n\n    if (today < coupon.validFrom || today > coupon.validUntil) {\n        return { valid: false, message: \"クーポンの有効期限外です\" };\n    }\n\n    if (coupon.usedCount >= coupon.maxUses) {\n        return { valid: false, message: \"クーポンの利用上限に達しています\" };\n    }\n\n    // Check if coupon is valid for this studio\n    if (\n        coupon.targetStudioIds.length > 0 &&\n        !coupon.targetStudioIds.includes(studioId)\n    ) {\n        return { valid: false, message: \"このスタジオでは使用できません\" };\n    }\n\n    return {\n        valid: true,\n        discount: {\n            type: coupon.discountType,\n            value: coupon.discountValue,\n        },\n    };\n}\n\n// Use coupon (increment usage count)\nexport async function useCoupon(code: string): Promise<{ success: boolean }> {\n    const coupons = await fetchCoupons();\n    const couponIndex = coupons.findIndex((c) => c.code === code);\n\n    if (couponIndex === -1) {\n        return { success: false };\n    }\n\n    const coupon = coupons[couponIndex];\n    coupon.usedCount += 1;\n\n    // Deactivate if max uses reached\n    if (coupon.usedCount >= coupon.maxUses) {\n        coupon.isActive = false;\n    }\n\n    await saveCouponToFirestore(coupon);\n\n    return { success: true };\n}\n\n// Update coupon status (called by cron job to deactivate expired coupons)\nexport async function updateCouponStatus(): Promise<void> {\n    const coupons = await fetchCoupons();\n    const today = new Date().toISOString().split(\"T\")[0];\n\n    let updated = false;\n\n    for (const coupon of coupons) {\n        const shouldBeActive =\n            coupon.validFrom <= today &&\n            coupon.validUntil >= today &&\n            coupon.usedCount < coupon.maxUses;\n\n        if (coupon.isActive !== shouldBeActive) {\n            coupon.isActive = shouldBeActive;\n            await saveCouponToFirestore(coupon);\n        }\n    }\n}\n"],"names":[],"mappings":"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"}